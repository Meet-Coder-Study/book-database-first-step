# 9장. 백업과 복구 - 장애에 대비하는 구조

### 지속성과 성능이 양립하는 구조

트랜잭션의 ACID성질 중 Durability에 의해 한 번 반영(commit)된 동작은 영속화된다. 정상적인 동작 시 뿐만아니라 데이터베이스 서버나 OS의 비정상적인 종료 등 시스템 장애에서도 유지된다. 보존되는  데이터는 대부분 하드디스크에 저장된는데, 동기화 쓰기를 하면 성능에 부정적이기 때문에 로그 선행 쓰기(WAL 로그), 데이터베이스 버퍼 구조를 이용해 데이터베이스 파일에 동기화한다.

**로그 선행 쓰기 - WAL(write ahead log)**

변경에 대한 로그 레코드를 이용해서 동기화한다

MySQL에서는 InnoDB 로그라고 부른다

- 디스크에 연속해서 쓰기 때문에 무작위로 쓰는 것보다 성능이 좋다
- 디스크에 쓰는 용량과 횟수를 줄일 수 있다
- 데이터베이스 버퍼를 이용해 데이터베이스의 데이터 파일로의 변경을 효율성 높게 수행한다

**데이터베이스 버퍼**

WAL에 변경을 작성하기 때문에 트랜잭션 커밋마다 동기화 할 필요가 없다. 하지만 계속해서 비동기적인 쓰기를 하면 로그와 데이터 파일 간 일관성을 유지하기 어렵다

→ 데이터 파일로의 입력을 데이터베이스 버퍼 경유로 일원화해서 단순화

→ 효율적으로 데이터의 일관성 유지 가능

**MySQL 갱신 흐름**

1. 갱신 대상 데이터를 포함한 페이지가 버퍼 풀에 있는지 확인하고 없다면 파일에서 읽어들인다
2. 버퍼 풀의 해당 페이지에서 갱신을 수행한다
3. 2의 갱신 내용이 커밋과 함께 로그에 기록된다. 버퍼 풀에 갱신되었지만, 아직 데이터 파일에 써지지 않은 페이지는 버퍼풀 내에서 더티 페이지로 다룬다
4. 데이터 페이지는 나중에 적당한 타이(체크 포인트)밍에 정리되어 데이터 파일로 써진다
5. 4의 체크포인트 이전 로그 파일은 불필요해진다. 갱신과 더불어 1부터 순서가 반복된다

**크래시 발생시 각 구조의 상태**

- WAL: 마지막으로 커밋된 트랜잭션의 갱신 정보를 가진다
- 데이터베이스 버퍼: 크래시로 내용이 소실된다
- 데이터베이스 파일: 최종 체크포인트까지 갱신 정보를 가진다

크래시(예를 들어 MySQL 서버의 비정상적 종료)시, 체크포인트 이후의 WAL로그를 데이터베이스 파일에 반영

⇒ 롤 포워드

### 백업과 복구

DBMS의 복구 구조가 존재하지만 논리적 파괴(DDL 문에 따른 테이블 파기)나 물리적 파손(디스크 장치 고장)에는 대응이 불가능하다. 따라서 주기적으로 백업하고 그를 이용해 복원이나 복구하는 것이 좋다.

**PIRT?**

Point-in-time Recovery: 백업 이후의 임의의 시점으로 복원하는 것

실행된 갱신을 기록한 로그를 보존해서 복원한 데이터베이스에 순차 반영해서 복원할 수 있다

**바이너리 로그**

MySQL에서 PIRT를 위해 사용하는 로그(InnoDB 포함 모든 MySQL)

InnoDB 로그는 크래시 복구에만 이용(InnoDB 전용)

**백업의 관점**

1. 핫 백업(온라인 백업) vs 콜드 백업(오프라인 백업)
    
    백업 시 데이터베이스의 상태에 따라 구분 → 백업 도중 DB 접근이 가능한지 안한지
    
    - 핫 백업: 트랜잭션 구조 or 특수 로그 지정 or OS나 하드웨어의 스냅샷을 사용하기도!
2. 논리 백업 vs 물리 백업
    - 논리 백업: SQL기반 텍스트 백업(장애가 발생한 이유를 알 수 있다, 이식성 우수, 파일이 큼)
    - 물리 백업: 데이터 영역을 그대로 덤프하는 이미지로 바이너리 형식으로 기록(가볍고 빠름, 호환 어렵)
3. 풀 백업 vs 부분 백업
    - 풀 백업: 전체 백업(단순, 시간이 오래 걸림, 용량이 많이 필요)
         ![Untitled](https://t1.daumcdn.net/cfile/tistory/992364475CCED7DA2E)
    - 부분 백업: 풀 백업 후 이후 갱신된 데이터를 백업(빠르고 용량이 작음, 복원 절차가 복잡)
        - 증분 백업
        
        ![Untitled](https://t1.daumcdn.net/cfile/tistory/99565D4C5CCED8191A)
        - 차등 백업
        
        ![Untitled](https://t1.daumcdn.net/cfile/tistory/993ED7425CCED8621F)
    
    **롤 포워드 리커버리**
    
    현재 데이터 베이스 = 풀 백업한 데이터 + 풀 백업 후 얻은 모든 증분 백업(바이너리 로그)
    

### 데이터 베이스 관리 시 주의점

- 백업 파일은 데이터베이스와 다른 디스크 장치로 나눠 보관할 것
- 가능하면 물리적으로 분리하는 것도 좋음
- 데이터베이스 장애는 자연 현상. 언제나 일어날 수 있음을 기억하고 대책을 세우고 비율을 줄이기 위해 노력해야함
    
    → 백업과 복구에 걸리는 시간, 부하 측정해 운영하기
    
- 백업을 필요로 하는 시스템의 상황에 맞게 백업 방식을 선정할 것